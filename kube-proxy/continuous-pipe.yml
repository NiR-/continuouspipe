tasks:
    images:
        build:
            services:
                web:
                    image: docker.io/continuouspipe/kube-proxy
                    naming_strategy: sha1
    deployment:
            deploy:
                cluster: ${CLUSTER}
                environment:
                    name: '"kube-proxy-" ~ code_reference.branch'
                services:
                    web:
                        specification:
                            accessibility:
                                from_external: true

                        endpoints:
                            -
                                name: https
                                type: NodePort
                                ssl_certificates:
                                    -
                                        name: kube-proxy-cert
                                        cert: ${WILDCARD_SSL_CERT}
                                        key: ${WILDCARD_SSL_KEY}

                        deployment_strategy:
                            readiness_probe:
                                type: tcp
                                port: 6379

                            liveness_probe:
                                initial_delay_seconds: 5
                                timeout_seconds: 5
                                period_seconds: 5
                                type: https
                                port: 8080
                                path: /healthz