environment_variables:
    - name: KEEN_PROJECT_ID
      value: 56572b8e90e4bd47230e1add
    - name: KEEN_WRITE_KEY
      value: 5d3a020fd710c5fd231394e8c2912a0cc50bf2142586ffdd13105b2f15cb525ded70fd3342a5ad7a273cd2e416cd777716264f3b8003ef1c193dbf737d02d5f85619df8ec4b29c780185b70cde839a7d93bcda17f6f2aa729a3cff4f24ff8031d39f70eafd604958409a5f99cc364586
    - name: BUILDER_URL
      value: http://api.3636576e-677a-11e5-bf13-4b0c2fa0d3cf-master.proxy.fra-02.cluster.continuouspipe.io
tasks:
    images:
        build:
            environment:
                - name: GITHUB_TOKEN
                  value: ${GITHUB_TOKEN}

            services:
                api:
                    image: docker.io/inviqasession/cp-river

    production:
        deploy:
            cluster: gke
            services:
                rabbitmq:
                    locked: true

                blackfire:
                    locked: true

                api:
                    specification:
                        accessibility:
                            from_external: true

                        environment_variables:
                            - name: AUTHENTICATOR_URL
                              value: http://authenticator.continuouspipe.io
                            - name: LOGSTREAM_URL
                              value: https://api.logstream.continuouspipe.io
                            - name: LOGSTREAM_FRONTEND_URL
                              value: http://logstream.continuouspipe.io
                            - name: BUILDER_URL
                              value: ${BUILDER_URL}
                            - name: PIPE_URL
                              value: http://pipe.continuouspipe.io
                            - name: RIVER_UI_URL
                              value: http://ui.continuouspipe.io
                            - name: RIVER_URL
                              value: ${SERVICE_API_PUBLIC_ENDPOINT}
                            - name: KEEN_PROJECT_ID
                              value: ${KEEN_PROJECT_ID}
                            - name: KEEN_WRITE_KEY
                              value: ${KEEN_WRITE_KEY}
                            - name: SENTRY_DSN
                              value: http://a28df8b25bdb4b8eb1b335849fa7daad:9401ad376e8b4c54b0a1138bb8093b2c@sentry.tools.sroze.io/10
                            - name: DATABASE_HOST
                              value: 104.155.7.25
                            - name: DATABASE_USER
                              value: river
                            - name: DATABASE_PASSWORD
                              value: 138xHEqgD93lk

                worker:
                    specification:
                        accessibility:
                            from_cluster: false
                        source:
                            from_service: api
                        environment_variables:
                            - name: AUTHENTICATOR_URL
                              value: http://authenticator.continuouspipe.io
                            - name: LOGSTREAM_URL
                              value: https://api.logstream.continuouspipe.io
                            - name: LOGSTREAM_FRONTEND_URL
                              value: http://logstream.continuouspipe.io
                            - name: BUILDER_URL
                              value: ${BUILDER_URL}
                            - name: PIPE_URL
                              value: http://pipe.continuouspipe.io
                            - name: RIVER_URL
                              value: ${SERVICE_API_PUBLIC_ENDPOINT}
                            - name: KEEN_PROJECT_ID
                              value: ${KEEN_PROJECT_ID}
                            - name: KEEN_WRITE_KEY
                              value: ${KEEN_WRITE_KEY}
                            - name: SENTRY_DSN
                              value: http://a28df8b25bdb4b8eb1b335849fa7daad:9401ad376e8b4c54b0a1138bb8093b2c@sentry.tools.sroze.io/10
                            - name: DATABASE_HOST
                              value: 104.155.7.25
                            - name: DATABASE_USER
                              value: river
                            - name: DATABASE_PASSWORD
                              value: 138xHEqgD93lk
        filter:
            expression: code_reference.branch == 'master'

    migrations:
        run:
            cluster: gke
            image:
                from_service: api
            commands:
                - composer run-script update-parameters
                - php app/console doctrine:migrations:migrate --no-interaction

            environment_variables:
                - name: DATABASE_HOST
                  value: 104.155.7.25
                - name: DATABASE_USER
                  value: river
                - name: DATABASE_PASSWORD
                  value: 138xHEqgD93lk

        filter:
            expression: code_reference.branch == 'master'

