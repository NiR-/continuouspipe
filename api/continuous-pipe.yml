pipelines:
    - name: Staging
      condition: code_reference.branch == 'master'
      tasks: [ images, migrations, deployment ]
    - name: Production
      condition: code_reference.branch == 'production'
      tasks: [ images, migrations, deployment ]
    - name: Pull-request CI
      condition: code_reference.branch not in ['master', 'production']
      tasks: [ images ]
    - name: Pre-staging environment
      condition: '"cp:tide" in pull_request.labels'
      tasks: [ images, deployment ]

variables:
    - name: BUILDER_URL
      condition: code_reference.branch == 'production'
      value: https://builder.continuouspipe.io
    - name: AUTHENTICATOR_URL
      condition: code_reference.branch == 'production'
      value: https://authenticator.continuouspipe.io
    - name: PIPE_URL
      condition: code_reference.branch == 'production'
      value: http://api.pipe-production.svc.cluster.local
    - name: RIVER_UI_URL
      condition: code_reference.branch == 'production'
      value: https://ui.continuouspipe.io
    - name: RIVER_HOST
      condition: code_reference.branch == 'production'
      value: river.continuouspipe.io
    - name: STACK_RABBITMQ_HOST
      condition: code_reference.branch == 'production'
      value: rabbitmq.stack-production.svc.cluster.local
    - name: REDIS_HOST
      condition: code_reference.branch == 'production'
      value: redis-sentinel-0.redis-sentinel-headless.stack-production.svc.cluster.local:26379,redis-sentinel-1.redis-sentinel-headless.stack-production.svc.cluster.local:26379,redis-sentinel-2.redis-sentinel-headless.stack-production.svc.cluster.local:26379
    - name: K8S_WATCHER_URL
      condition: code_reference.branch == 'production'
      value: http://api.k8s-watcher-master.svc.cluster.local # We don't have a production one, yet.

    - name: BUILDER_URL
      condition: code_reference.branch != 'production'
      value: https://builder-staging.continuouspipe.io
    - name: AUTHENTICATOR_URL
      condition: code_reference.branch != 'production'
      value: https://authenticator-staging.continuouspipe.io
    - name: PIPE_URL
      condition: code_reference.branch != 'production'
      value: http://api.pipe-master.svc.cluster.local
    - name: RIVER_UI_URL
      condition: code_reference.branch != 'production'
      value: https://ui-staging.continuouspipe.io
    - name: RIVER_HOST
      condition: code_reference.branch != 'production'
      value: river-staging.continuouspipe.io
    - name: STACK_RABBITMQ_HOST
      condition: code_reference.branch != 'production'
      value: rabbitmq.stack-master.svc.cluster.local
    - name: REDIS_HOST
      condition: code_reference.branch != 'production'
      value: redis-sentinel-0.redis-sentinel-headless.stack-master.svc.cluster.local:26379,redis-sentinel-1.redis-sentinel-headless.stack-master.svc.cluster.local:26379,redis-sentinel-2.redis-sentinel-headless.stack-master.svc.cluster.local:26379
    - name: K8S_WATCHER_URL
      condition: code_reference.branch == 'production'
      value: http://api.k8s-watcher-master.svc.cluster.local # We don't have a production one, yet.

tasks:
    images:
        build:
            environment:
                - name: GITHUB_TOKEN
                  value: ${GITHUB_TOKEN}

            services:
                api:
                    image: docker.io/inviqasession/cp-river

    deployment:
        deploy:
            cluster: ${CLUSTER}
            environment:
                name: '"river-" ~ code_reference.branch'

            services:
                rabbitmq:
                    locked: true

                    deployment_strategy:
                        readiness_probe:
                            type: tcp
                            port: 5672

                blackfire:
                    locked: true

                api:
                    endpoints:
                        -
                            name: ingress
                            ingress:
                                class: nginx
                                host: ${RIVER_HOST}
                            ssl_certificates:
                                - name: auto
                                  cert: automatic
                                  key: automatic

                    specification:
                        environment_variables: &ENV
                            - name: AUTHENTICATOR_URL
                              value: ${AUTHENTICATOR_URL}
                            - name: LOGSTREAM_URL
                              value: https://api.logstream.continuouspipe.io
                            - name: LOGSTREAM_FRONTEND_URL
                              value: http://logstream.continuouspipe.io
                            - name: BUILDER_URL
                              value: ${BUILDER_URL}
                            - name: PIPE_URL
                              value: ${PIPE_URL}
                            - name: RIVER_UI_URL
                              value: ${RIVER_UI_URL}
                            - name: RIVER_HOST
                              value: ${RIVER_HOST}
                            - name: KEEN_PROJECT_ID
                              value: ${KEEN_PROJECT_ID}
                            - name: KEEN_WRITE_KEY
                              value: ${KEEN_WRITE_KEY}
                            - name: SENTRY_DSN
                              value: ${SENTRY_DSN}
                            - name: DATABASE_HOST
                              value: ${DATABASE_HOST}
                            - name: DATABASE_USER
                              value: ${DATABASE_USER}
                            - name: DATABASE_PASSWORD
                              value: ${DATABASE_PASSWORD}
                            - name: TIDEWAYS_API_KEY
                              value: ${TIDEWAYS_API_KEY}
                            - name: BITBUCKET_OAUTH_KEY
                              value: ${BITBUCKET_OAUTH_KEY}
                            - name: BITBUCKET_OAUTH_SECRET
                              value: ${BITBUCKET_OAUTH_SECRET}
                            - name: AUTHENTICATOR_API_KEY
                              value: ${AUTHENTICATOR_API_KEY}
                            - name: ADMIN_PASSWORD
                              value: ${ADMIN_PASSWORD}
                            - name: HOSTED_GRAPHITE_API_KEY
                              value: ${HOSTED_GRAPHITE_API_KEY}
                            - name: K8S_WATCHER_URL
                              value: ${K8S_WATCHER_URL}
                            - name: K8S_HEALTH_CHECKER_URL
                              value: http://health-checker.chc-master.svc.cluster.local
                            - name: ZIPKIN_BASE_URL
                              value: http://zipkin.zipkin-master.svc.cluster.local:9411
                            - name: APP_USER_LOCAL
                              value: false
                            - name: STACK_RABBITMQ_HOST
                              value: ${STACK_RABBITMQ_HOST}
                            - name: HOSTED_GRAPHITE_API_KEY
                              value: ${HOSTED_GRAPHITE_API_KEY}
                            - name: GITHUB_SECRET
                              value: ${GITHUB_SECRET}
                            - name: GITHUB_INTEGRATION_ID
                              value: ${GITHUB_INTEGRATION_ID}
                            - name: GITHUB_INTEGRATION_KEY_NAME
                              value: ${GITHUB_INTEGRATION_KEY_NAME}
                            - name: GOOGLE_PUB_SUB_MAIN_TOPIC
                              value: ${GOOGLE_PUB_SUB_TOPIC}
                            - name: GOOGLE_PUB_SUB_MAIN_SUBSCRIPTION_NAME
                              value: ${GOOGLE_PUB_SUB_SUBSCRIPTION_NAME}
                            - name: GOOGLE_PUB_SUB_OPERATIONS_TOPIC
                              value: ${GOOGLE_PUB_SUB_OPERATIONS_TOPIC}
                            - name: GOOGLE_PUB_SUB_OPERATIONS_SUBSCRIPTION_NAME
                              value: ${GOOGLE_PUB_SUB_OPERATIONS_SUBSCRIPTION_NAME}
                            - name: GOOGLE_PUB_SUB_DELAYED_TOPIC
                              value: ${GOOGLE_PUB_SUB_DELAYED_TOPIC}
                            - name: GOOGLE_PUB_SUB_DELAYED_SUBSCRIPTION_NAME
                              value: ${GOOGLE_PUB_SUB_DELAYED_SUBSCRIPTION_NAME}
                            - name: LOGITIO_API_KEY
                              value: ${LOGITIO_API_KEY}
                            - name: FLEX_CLUSTER_ADDRESS
                              value: ${FLEX_CLUSTER_ADDRESS}
                            - name: FLEX_QUAY_IO_ACCESS_TOKEN
                              value: ${FLEX_QUAY_IO_ACCESS_TOKEN}
                            - name: FLEX_QUAY_IO_ORGANISATION
                              value: ${FLEX_QUAY_IO_ORGANISATION}
                            - name: FLEX_CLOUD_FLARE_ZONE
                              value: ${FLEX_CLOUD_FLARE_ZONE}
                            - name: FLEX_CLOUD_FLARE_EMAIL
                              value: ${FLEX_CLOUD_FLARE_EMAIL}
                            - name: FLEX_CLOUD_FLARE_API_KEY
                              value: ${FLEX_CLOUD_FLARE_API_KEY}
                            - name: REDIS_HOST
                              value: ${REDIS_HOST}

                    deployment_strategy:
                        readiness_probe:
                            type: http
                            port: 80
                            path: /

                worker:
                    specification:
                        accessibility:
                            from_cluster: false
                        source:
                            from_service: api
                        environment_variables:
                            <<: *ENV
                            1000:
                              name: START_NGINX
                              value: 'false'
                            1001:
                              name: START_PHP_FPM
                              value: 'false'
                            1002:
                              name: START_WORKER
                              value: 'true'
                            1003:
                              name: WORKER_CONNECTION_NAME
                              value: main

                worker_operations:
                    specification:
                        accessibility:
                            from_cluster: false
                        source:
                            from_service: api
                        environment_variables:
                            <<: *ENV
                            1000:
                              name: START_NGINX
                              value: 'false'
                            1001:
                              name: START_PHP_FPM
                              value: 'false'
                            1002:
                              name: START_WORKER
                              value: 'true'
                            1003:
                              name: WORKER_CONNECTION_NAME
                              value: operations

                worker_delayed:
                    specification:
                        accessibility:
                            from_cluster: false
                        source:
                            from_service: api
                        environment_variables:
                            <<: *ENV
                            1000:
                              name: START_NGINX
                              value: 'false'
                            1001:
                              name: START_PHP_FPM
                              value: 'false'
                            1002:
                              name: START_WORKER
                              value: 'true'
                            1003:
                              name: WORKER_CONNECTION_NAME
                              value: delayed

                tideways:
                    specification:
                        resources:
                            limits:
                                cpu: 50m
                                memory: 100Mi

                cron:
                    specification:
                        source:
                            from_service: api

                        environment_variables:
                            <<: *ENV
                            1000:
                              name: START_NGINX
                              value: 'false'
                            1001:
                              name: START_PHP_FPM
                              value: 'false'
                            1002:
                              name: START_CRON
                              value: 'true'

                        accessibility:
                            from_cluster: false

    migrations:
        run:
            cluster: ${CLUSTER}
            environment:
                name: '"river-" ~ code_reference.branch'
            image:
                from_service: api
            commands:
                - composer run-script update-parameters
                - php app/console doctrine:migrations:migrate --no-interaction

            environment_variables:
                <<: *ENV

notifications:
    inviqa_slack:
        slack:
            webhook_url: https://hooks.slack.com/services/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
