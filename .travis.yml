language: php

dist: xenial
sudo: required

matrix:
    include:
        - php: 7.1

env:
    global:
        - DATABASE_HOST=127.0.0.1
        - DATABASE_USER=root
        - DATABASE_PASSWORD=
        - REDIS_HOST=127.0.0.1

services:
    - mysql
    - redis-server
    - docker

before_install:
    - sudo apt-get install -y librabbitmq-dev curl bzip2
    - printf "\n" | pecl install amqp
    - curl -o /tmp/shellcheck.tar.bz2 https://s3.amazonaws.com/travis-blue-public/binaries/ubuntu/14.04/x86_64/shellcheck-0.4.5.tar.bz2
    - tar -C /tmp -xf /tmp/shellcheck.tar.bz2
    - sudo mv /tmp/shellcheck-0.4.5/shellcheck /usr/local/bin/

install:
    - pushd api && composer install && popd

script:
    - source .env.dist

    # API tests
    - pushd api/
    - vendor/bin/phpspec --no-interaction run
    - vendor/bin/phpunit
    # Shell script tests
    - for file in $(find .. -type f \( -perm +111 -or -name "*.sh" \) ! -path "*/vendor/*" ! -path "*/.git/*" ! -path "*/api/bin/console" ! -path "*/api/bin/symfony_requirements"); do shellcheck --exclude SC1091 "$file"; done
    - vendor/bin/behat --profile=domain -fprogress

    - bin/console doctrine:database:create --no-interaction
    - bin/console doctrine:migrations:migrate --no-interaction
    - vendor/bin/behat --profile=smoke -fprogress
    - popd

after_success:
    - |
      if [ "$TRAVIS_BRANCH" == "master" ] && [ "$TRAVIS_PULL_REQUEST" == "false" ] ; then
        docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
        docker-compose -f docker-compose.yml -f docker-compose.images.yml build && docker-compose -f docker-compose.yml -f docker-compose.with-images.yml push;
      fi
